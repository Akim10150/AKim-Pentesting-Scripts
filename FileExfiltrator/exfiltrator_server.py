import socket
import threading
import base64
import os

print("Exfiltrator Server running :)!!!You may need to run with Sudo if you're trying to use port 80!!!")
try:
    input = raw_input
except NameError:
    pass

bind_ip=input('Enter Server Bind IP:\n')
bind_portstring=input('Enter Server Bind Port:\n')
bind_port=int(bind_portstring)

print("Server now should be up...")
server=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
server.bind((bind_ip,bind_port))
server.listen(5)
path=os.getcwd()+"/"



def handle_client(client_socket):
	buffer=""
	a=1
	global path
	while a:
		data=client_socket.recv(4096)
		if not data:
			a=0
		buffer+=data.decode()
	filedataarray=buffer.split(",")
	filename=filedataarray[0]
	print('Downloading %s ...' % filename)
	filebuffer=filedataarray[1]
	filedata=base64.b64decode(filebuffer)
	path+="%s" % filename
	print('Downloading to %s' % path)
	fd=open(path,'wb')
	fd.write(filedata)
	fd.close()
	path=os.getcwd()+"/"
	print("Download Complete!")
	client_socket.close()

while 1:
	client,addr=server.accept()
	print ("Connected to %s:%d" % (addr[0],addr[1]))
	client_handler=threading.Thread(target=handle_client,args=(client,))
	client_handler.start()
